(()=>{"use strict";function e(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",t)}function t(t){if("Escape"===t.key){var n=document.querySelector(".popup_is-opened");n&&e(n)}}function n(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",t)}function o(e,t,n,o,r,c,i){var u=n.querySelector(".card").cloneNode(!0),a=u.querySelector(".card__image"),l=u.querySelector(".card__like-counter"),s=u.querySelector(".card__delete-button"),d=u.querySelector(".card__like-button");return a.src=o.link,a.alt="Изображение, отражающее красоту места "+o.name,l.textContent=o.likes.length,function(e,t){var n=!1;return t.forEach((function(t){t._id===e&&(n=!0)})),n}(t,o.likes)&&d.classList.add("card__like-button_is-active"),u.querySelector(".card__title").textContent=o.name,o.owner._id===t?s.addEventListener("click",(function(){i(u,o._id)})):s.classList.add("card__delete-button_inactive"),d.addEventListener("click",(function(){!function(e,t,n,o,r){n.classList.contains("card__like-button_is-active")?t.removeLike(e,r).then((function(e){n.classList.remove("card__like-button_is-active"),o.textContent=e.likes.length})).catch((function(e){console.log("Ошибка удаления лайка карточки ".concat(e))})):t.addLike(e,r).then((function(e){n.classList.add("card__like-button_is-active"),o.textContent=e.likes.length})).catch((function(e){console.log("Ошибка лайка карточки ".concat(e))}))}(e,r,d,l,o._id)})),a.addEventListener("click",(function(){c(o)})),u}function r(e,t,n){t.classList.remove(e.inputErrorClass),n.textContent="",n.classList.remove(e.errorVisibilityClass)}function c(e,t,n){!function(e){return e.some((function(e){return!e.validity.valid}))}(t)?n.classList.remove(e.inactiveButtonClass):n.classList.add(e.inactiveButtonClass)}function i(e,t){Array.from(e.querySelectorAll(t.inputSelector)).forEach((function(n){var o=e.querySelector(".".concat(n.id,"-error"));r(t,n,o)})),e.querySelector(t.submitButtonSelector).classList.add(t.inactiveButtonClass)}function u(e,t){return fetch(e,{headers:{authorization:t.authorization}}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}function a(e,t,n){return fetch(e,{method:"PATCH",headers:t,body:JSON.stringify(n)}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}function l(e,t){return fetch(e,{method:"DELETE",headers:t}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}))}var s,d={getCards:function(e){return u(e.baseUrl+"/cards",e.headers)},addNewCard:function(e,t){return n=e.baseUrl+"/cards",o=e.headers,r=t,fetch(n,{method:"POST",headers:o,body:JSON.stringify(r)}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}));var n,o,r},deleteCard:function(e,t){return l(e.baseUrl+"/cards/"+t,e.headers)},addLike:function(e,t){return n=e.baseUrl+"/cards/likes/"+t,o=e.headers,fetch(n,{method:"PUT",headers:o}).then((function(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}));var n,o},removeLike:function(e,t){return l(e.baseUrl+"/cards/likes/"+t,e.headers)}},p={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorVisibilityClass:"popup__error_visible"},_={baseUrl:"https://nomoreparties.co/v1/wff-cohort-22",headers:{authorization:"68a7de7a-4657-4ffc-8eeb-1ef94cb920e6","Content-Type":"application/json"}},f=null,m=null,y=document.querySelector("#card-template").content,v=document.querySelector(".places__list"),h=document.querySelector(".profile__title"),S=document.querySelector(".profile__description"),b=document.querySelector(".profile__image"),q=document.querySelector(".profile__edit-button"),k=document.querySelector(".popup_type_edit"),L=k.querySelector(".popup__form"),C=L.querySelector(".popup__input_type_name"),E=L.querySelector(".popup__input_type_description"),g=document.querySelector(".profile__image_edit-button"),x=document.querySelector(".popup_type_avatar"),j=x.querySelector(".popup__form"),U=x.querySelector(".popup__input_type_url"),A=document.querySelector(".profile__add-button"),P=document.querySelector(".popup_type_new-card"),w=P.querySelector(".popup__form"),B=w.querySelector(".popup__input_type_card-name"),D=w.querySelector(".popup__input_type_url"),N=document.querySelector(".popup_type_delete-card"),T=N.querySelector(".popup__form"),V={element:null,id:null},z=document.querySelector(".popup_type_image"),M=z.querySelector(".popup__image"),O=z.querySelector(".popup__caption"),J=document.querySelectorAll(".popup");function H(e){M.src=e.link,M.alt="Детальное изображение места"+e.name,O.textContent=e.name,n(z)}function F(e,t){V.element=e,V.id=t,n(N)}function G(e,t){e.querySelector(".popup__button").textContent=t?"Сохранение...":"Сохранить"}q.addEventListener("click",(function(){C.value=h.textContent,E.value=S.textContent,i(L,p),n(k)})),g.addEventListener("click",(function(){U.value="",i(j,p),n(x)})),A.addEventListener("click",(function(){B.value="",D.value="",i(w,p),n(P)})),L.addEventListener("submit",(function(t){var n,o;t.preventDefault(),G(L,!0),(n=_,o={name:C.value,about:E.value},a(n.baseUrl+"/users/me",n.headers,o)).then((function(t){h.textContent=t.name,S.textContent=t.about,e(k)})).catch((function(e){console.log("Ошибка обновления данных пользователя: ".concat(e))})).finally((function(){G(L,!1)}))})),j.addEventListener("submit",(function(t){var n,o;t.preventDefault(),G(j,!0),(n=_,o={avatar:U.value},a(n.baseUrl+"/users/me/avatar",n.headers,o)).then((function(t){b.src=t.avatar,e(x)})).catch((function(e){console.log("Ошибка обновления аватара: ".concat(e))})).finally((function(){G(j,!1)}))})),w.addEventListener("submit",(function(t){t.preventDefault(),G(w,!0),d.addNewCard(_,{name:B.value,link:D.value}).then((function(n){var r=o(_,f._id,y,n,d,H,F);v.prepend(r),t.target.reset(),e(P)})).catch((function(e){console.log("Ошибка добавления карточки: ".concat(e))})).finally((function(){G(w,!1)}))})),T.addEventListener("submit",(function(t){t.preventDefault(),d.deleteCard(_,V.id).then((function(t){V.element.remove(),V.element=null,V.id=null,e(N)})).catch((function(e){console.log("Ошибка удаления карточки ".concat(e))}))})),J.forEach((function(t){t.addEventListener("click",(function(n){n.target.classList.contains("popup")&&e(t)})),t.querySelector(".popup__close").addEventListener("click",(function(){e(t)}))})),function(e){Array.from(document.querySelectorAll(e.formSelector)).forEach((function(t){var n,o,i,u,a=Array.from(t.querySelectorAll(e.inputSelector)),l=t.querySelector(e.submitButtonSelector);o=t,c(n=e,i=a,u=l),i.forEach((function(e){var t=o.querySelector(".".concat(e.id,"-error"));e.addEventListener("input",(function(){c(n,i,u),function(e,t,n){t.validity.valid?r(e,t,n):(t.validity.patternMismatch?t.setCustomValidity(t.dataset.errorMessage):t.setCustomValidity(""),function(e,t,n,o){t.classList.add(e.inputErrorClass),n.textContent=o,n.classList.add(e.errorVisibilityClass)}(e,t,n,t.validationMessage))}(n,e,t)}))}))}))}(p),Promise.all([(s=_,u(s.baseUrl+"/users/me",s.headers)),d.getCards(_)]).then((function(e){var t;f=e[0],m=Array.from(e[1]),t=f,h.textContent=t.name,S.textContent=t.about,b.src=t.avatar,function(e,t){e.forEach((function(e){var n=o(_,t._id,y,e,d,H,F);v.append(n)}))}(m,f)})).catch((function(e){console.log("Ошибка загрузки данных: ".concat(e))}))})();